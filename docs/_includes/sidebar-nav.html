<!-- Sidebar Navigation (data-driven) -->
{% assign navigation = site.data.navigation %}
{%- assign _baseurl = site.baseurl | default: '' -%}
{%- assign _page_url_n = page.url -%}
{%- if _baseurl and _baseurl != '' -%}
  {%- assign _page_url_n = _page_url_n | remove_first: _baseurl -%}
{%- endif -%}

<div class="sidebar-content">
    <div class="book-info">
        <h2 class="book-title">{{ site.title | escape }}</h2>
        {% if site.subtitle %}
        <p class="book-subtitle">{{ site.subtitle | escape }}</p>
        {% elsif site.description %}
        <p class="book-subtitle">{{ site.description | escape }}</p>
        {% endif %}
    </div>

    <div class="toc">
        <h3 class="toc-title">目次</h3>

        <div class="toc-section">
            <ul class="toc-list">
                <li class="toc-item">
                    <a href="{{ '/' | relative_url }}" class="toc-link {% if _page_url_n == '/' or _page_url_n == '' %}active{% endif %}">
                        はじめに
                    </a>
                </li>
            </ul>
        </div>

        {% if navigation %}
            {% if navigation.introduction %}
            <div class="toc-section">
                <h4 class="toc-section-title">導入</h4>
                <ul class="toc-list">
                    {% for item in navigation.introduction %}
                    {% assign item_url = item.path | default: item.url %}
                    {% assign item_url_n = item_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign item_url_n = item_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign item_active = false %}
                    {% if item_url_n and item_url_n != '' %}
                      {% if _page_url_n == item_url_n or _page_url_n contains item_url_n %}
                        {% assign item_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item">
                        <a href="{{ item_url | relative_url }}" class="toc-link {% if item_active %}active{% endif %}" {% if item_active %}aria-current="page"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if navigation.chapters %}
            <div class="toc-section">
                <h4 class="toc-section-title">本編</h4>
                <ul class="toc-list">
                    {% for chapter in navigation.chapters %}
                    {% assign chapter_url = chapter.path | default: chapter.url %}
                    {% assign chapter_url_n = chapter_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign chapter_url_n = chapter_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign chapter_active = false %}
                    {% if chapter_url_n and chapter_url_n != '' %}
                      {% if _page_url_n == chapter_url_n or _page_url_n contains chapter_url_n %}
                        {% assign chapter_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item toc-chapter">
                        <a href="{{ chapter_url | relative_url }}" class="toc-link {% if chapter_active %}active{% endif %}" {% if chapter_active %}aria-current="page"{% endif %}>
                            {{ chapter.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if navigation.additional %}
            <div class="toc-section">
                <h4 class="toc-section-title">追加</h4>
                <ul class="toc-list">
                    {% for item in navigation.additional %}
                    {% assign item_url = item.path | default: item.url %}
                    {% assign item_url_n = item_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign item_url_n = item_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign item_active = false %}
                    {% if item_url_n and item_url_n != '' %}
                      {% if _page_url_n == item_url_n or _page_url_n contains item_url_n %}
                        {% assign item_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item">
                        <a href="{{ item_url | relative_url }}" class="toc-link {% if item_active %}active{% endif %}" {% if item_active %}aria-current="page"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if navigation.resources %}
            <div class="toc-section">
                <h4 class="toc-section-title">リソース</h4>
                <ul class="toc-list">
                    {% for item in navigation.resources %}
                    {% assign item_url = item.path | default: item.url %}
                    {% assign item_url_n = item_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign item_url_n = item_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign item_active = false %}
                    {% if item_url_n and item_url_n != '' %}
                      {% if _page_url_n == item_url_n or _page_url_n contains item_url_n %}
                        {% assign item_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item">
                        <a href="{{ item_url | relative_url }}" class="toc-link {% if item_active %}active{% endif %}" {% if item_active %}aria-current="page"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if navigation.appendices %}
            <div class="toc-section">
                <h4 class="toc-section-title">付録</h4>
                <ul class="toc-list">
                    {% for item in navigation.appendices %}
                    {% assign item_url = item.path | default: item.url %}
                    {% assign item_url_n = item_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign item_url_n = item_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign item_active = false %}
                    {% if item_url_n and item_url_n != '' %}
                      {% if _page_url_n == item_url_n or _page_url_n contains item_url_n %}
                        {% assign item_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item">
                        <a href="{{ item_url | relative_url }}" class="toc-link {% if item_active %}active{% endif %}" {% if item_active %}aria-current="page"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if navigation.afterword %}
            <div class="toc-section">
                <h4 class="toc-section-title">あとがき</h4>
                <ul class="toc-list">
                    {% for item in navigation.afterword %}
                    {% assign item_url = item.path | default: item.url %}
                    {% assign item_url_n = item_url %}
                    {% if _baseurl and _baseurl != '' %}
                      {% assign item_url_n = item_url_n | remove_first: _baseurl %}
                    {% endif %}
                    {% assign item_active = false %}
                    {% if item_url_n and item_url_n != '' %}
                      {% if _page_url_n == item_url_n or _page_url_n contains item_url_n %}
                        {% assign item_active = true %}
                      {% endif %}
                    {% endif %}
                    <li class="toc-item">
                        <a href="{{ item_url | relative_url }}" class="toc-link {% if item_active %}active{% endif %}" {% if item_active %}aria-current="page"{% endif %}>
                            {{ item.title }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        {% endif %}
    </div>

    <div class="sidebar-footer">
        {% assign repo_url = repo_url | default: site.github.repository_url | default: site.repository_url | default: site.repository.github | default: site.repository %}
        {% if repo_url and repo_url != '' %}
            {% unless repo_url contains 'http' %}
                {% assign repo_url = 'https://github.com/' | append: repo_url %}
            {% endunless %}
        {% endif %}

        <div class="external-links">
            {% if repo_url %}
            <a href="{{ repo_url }}" target="_blank" rel="noopener" class="external-link">GitHub</a>
            {% endif %}
            {% if site.contact.email %}
            <a href="mailto:{{ site.contact.email | escape }}" class="external-link">Contact</a>
            {% endif %}
        </div>
    </div>
</div>
